{"ast":null,"code":"import _objectSpread from\"/home/appinventiv/Documents/Project/tickt/web/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _regeneratorRuntime from\"/home/appinventiv/Documents/Project/tickt/web/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/home/appinventiv/Documents/Project/tickt/web/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import firebase from\"firebase/app\";import\"firebase/messaging\";import\"firebase/auth\";import\"firebase/database\";import storageService from\"../utils/storageService\";import Constants from\"../utils/constants\";import moment from\"moment\";if(!firebase.apps.length){firebase.initializeApp(Constants.qaStgFirebaseConfig);}var checkIfSupport=function checkIfSupport(){if(firebase.messaging.isSupported()){return firebase.messaging();}return false;};export var auth=firebase.auth();export var messaging=checkIfSupport();//firebase.messaging();\nexport var db=firebase.database();var CHAT_TYPE=\"single\";var FIREBASE_COLLECTION={ROOM_INFO:\"room_info\",JOBS:\"jobs\",INBOX:\"inbox\",MESSAGES:\"messages\",LAST_MESSAGES:\"lastMessage\",USERS:\"users\"};var loggedInuserId=\"\";var msgListnerObj;// let totalPendingCounter = 0;\nvar inboxListner;var getRegisterToken=function getRegisterToken(){return new Promise(function(resolve,reject){messaging.getToken({vapidKey:Constants.FirebasePushServiceKey}).then(function(currentToken){if(currentToken){console.log(\"firebase token fetched successsfully\",currentToken);resolve({success:true,deviceToken:currentToken});}else{console.log(\"No registration token available.\");setTokenSentToServer(false);resolve({success:false});}}).catch(function(err){console.log(\"An error occurred while retrieving  from firebase. \",err);setTokenSentToServer(false);reject({success:false});});});};var setTokenSentToServer=function setTokenSentToServer(sent){storageService.setItem(\"sentToServer\",sent?\"1\":\"0\");storageService.setItem(\"fcmToken\",\"\");};var isTokenSentToServer=function isTokenSentToServer(){return storageService.getItem(\"sentToServer\")===\"1\";};export var requestPermission=function requestPermission(){if(checkIfSupport()){return new Promise(function(resolve,reject){Notification.requestPermission().then(function(permission){var data=getRegisterToken();resolve(data);})// if (permission === 'granted' && isTokenSentToServer()) {\n//     const data = getRegisterToken();\n//     console.log('Token Already sent');\n//     resolve(data);\n// }\n.catch(function(err){console.log(\"Unable to get permission to show notification browser : \",err);reject({success:false});});});}};export var deleteToken=function deleteToken(){if(checkIfSupport()){messaging.deleteToken().then(function(){console.log(\"firebase Token deleted.\");}).catch(function(err){console.log(\"Unable to delete firebase token. \",err);});}};export var signOut=function signOut(){auth.signOut().then(function(){console.log(\"Firebase signout successful.\");}).catch(function(err){console.log(\"Firebase sign out error.\",err);});};export var firebaseSignUpWithEmailPassword=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(_ref){var email,password,id,fullName,user_type,ref;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:email=_ref.email,password=_ref.password,id=_ref.id,fullName=_ref.fullName,user_type=_ref.user_type;_context.prev=1;_context.next=4;return auth.createUserWithEmailAndPassword(email,password);case 4:ref=_context.sent;if(!ref){_context.next=11;break;}_context.next=8;return ref.user.updateProfile({displayName:fullName// photoURL: '',\n// roleId: user_type,\n});case 8:_context.next=10;return db.ref(\"\".concat(FIREBASE_COLLECTION.USERS,\"/\").concat(id)).set({email:email,image:\"\",name:fullName,// uid: ref.user[\"$\"][\"W\"],\nuserId:id,onlineStatus:true,userType:user_type});case 10:console.log(\"firebase authentication success\");case 11:_context.next=16;break;case 13:_context.prev=13;_context.t0=_context[\"catch\"](1);console.log(\"firebase authentication failure: \",{err:_context.t0});case 16:case\"end\":return _context.stop();}}},_callee,null,[[1,13]]);}));return function firebaseSignUpWithEmailPassword(_x){return _ref2.apply(this,arguments);};}();export var firebaseLogInWithEmailPassword=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(authData,loginRes,isSignup){var response;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:console.log(\"authData: \",authData);_context2.prev=1;_context2.next=4;return auth.signInWithEmailAndPassword(authData.email,authData.password);case 4:response=_context2.sent;if(!response){_context2.next=11;break;}console.log(\"firebase auth login success: \");if(!isSignup){_context2.next=9;break;}return _context2.abrupt(\"return\");case 9:_context2.next=11;return db.ref(\"\".concat(FIREBASE_COLLECTION.USERS,\"/\").concat(loginRes===null||loginRes===void 0?void 0:loginRes._id)).set({email:loginRes===null||loginRes===void 0?void 0:loginRes.email,image:loginRes===null||loginRes===void 0?void 0:loginRes.user_image,name:loginRes===null||loginRes===void 0?void 0:loginRes.userName,userId:loginRes===null||loginRes===void 0?void 0:loginRes._id,onlineStatus:true,userType:loginRes===null||loginRes===void 0?void 0:loginRes.user_type});case 11:_context2.next=16;break;case 13:_context2.prev=13;_context2.t0=_context2[\"catch\"](1);console.log(\"firebase auth login failure: \");case 16:case\"end\":return _context2.stop();}}},_callee2,null,[[1,13]]);}));return function firebaseLogInWithEmailPassword(_x2,_x3,_x4){return _ref3.apply(this,arguments);};}();////////////////////////  firebase chat\nexport var loginAnonymously=/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var userInfo,response,errorCode;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:userInfo=storageService.getItem(\"userInfo\");_context3.prev=1;_context3.next=4;return auth.signInAnonymously();case 4:response=_context3.sent;if(!response){_context3.next=9;break;}console.log(\"firebase anonymous auth login success: \");_context3.next=9;return db.ref(\"\".concat(FIREBASE_COLLECTION.USERS,\"/\").concat(userInfo===null||userInfo===void 0?void 0:userInfo._id)).update({email:userInfo===null||userInfo===void 0?void 0:userInfo.email,image:userInfo===null||userInfo===void 0?void 0:userInfo.user_image,name:userInfo===null||userInfo===void 0?void 0:userInfo.userName,userId:userInfo===null||userInfo===void 0?void 0:userInfo._id,onlineStatus:true,userType:userInfo===null||userInfo===void 0?void 0:userInfo.user_type,deviceType:1});case 9:_context3.next=16;break;case 11:_context3.prev=11;_context3.t0=_context3[\"catch\"](1);console.log(\"firebase anonymous auth login failure: \");errorCode=_context3.t0.code;if(errorCode===\"auth/operation-not-allowed\"){alert(\"You must enable Anonymous auth in the Firebase Console.\");}else{console.error(_context3.t0);}case 16:case\"end\":return _context3.stop();}}},_callee3,null,[[1,11]]);}));return function loginAnonymously(){return _ref4.apply(this,arguments);};}();export var getLoggedInuserId=function getLoggedInuserId(){var _storageService$getIt;return(_storageService$getIt=storageService.getItem(\"userInfo\"))===null||_storageService$getIt===void 0?void 0:_storageService$getIt._id;};export var updateChatUserDetails=/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(updateType,value){var loggedInuserId;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:loggedInuserId=getLoggedInuserId();_context4.prev=1;_context4.next=4;return db.ref(\"\".concat(FIREBASE_COLLECTION.USERS,\"/\").concat(loggedInuserId)).update(_objectSpread(_objectSpread(_objectSpread(_objectSpread({},updateType===\"userImage\"&&{image:value}),updateType===\"userName\"&&{name:value}),updateType===\"deviceToken\"&&{deviceToken:value}),updateType===\"isNotification\"&&{isNotification:value}));case 4:console.log(\"firebase \".concat(updateType,\" update success\"));_context4.next=10;break;case 7:_context4.prev=7;_context4.t0=_context4[\"catch\"](1);console.log(\"firebase \".concat(updateType,\" update failure: \"),{err:_context4.t0});case 10:case\"end\":return _context4.stop();}}},_callee4,null,[[1,7]]);}));return function updateChatUserDetails(_x5,_x6){return _ref5.apply(this,arguments);};}();export var createRoom=/*#__PURE__*/function(){var _ref6=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(jobId,tradieId,builderId,jobName){var loggedInuserId,roomID,roomInfoObj,chatLastUpdates,chatRoomMembers;return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:loggedInuserId=getLoggedInuserId();roomID=\"\".concat(jobId,\"_\").concat(tradieId,\"_\").concat(builderId);_context5.next=4;return checkRoomExist(roomID);case 4:if(!_context5.sent){_context5.next=6;break;}return _context5.abrupt(\"return\");case 6:roomInfoObj={id:roomID,chatRoomType:CHAT_TYPE,chatLastUpdate:firebase.database.ServerValue.TIMESTAMP};chatLastUpdates={};chatLastUpdates[tradieId]=tradieId===loggedInuserId?firebase.database.ServerValue.TIMESTAMP:0;chatLastUpdates[loggedInuserId]=firebase.database.ServerValue.TIMESTAMP;chatRoomMembers={};chatRoomMembers[tradieId]={memberDelete:firebase.database.ServerValue.TIMESTAMP,memberJoin:firebase.database.ServerValue.TIMESTAMP,memberLeave:0};chatRoomMembers[builderId]={memberDelete:firebase.database.ServerValue.TIMESTAMP,memberJoin:firebase.database.ServerValue.TIMESTAMP,memberLeave:0};roomInfoObj.chatRoomMembers=chatRoomMembers;roomInfoObj.chatLastUpdates=chatLastUpdates;_context5.next=17;return db.ref(\"\".concat(FIREBASE_COLLECTION.ROOM_INFO,\"/\").concat(roomID,\"/\")).set(roomInfoObj);case 17:_context5.next=19;return createInbox(tradieId,roomID,jobId,builderId,jobName);case 19:_context5.next=21;return createInbox(builderId,roomID,jobId,tradieId,jobName);case 21:return _context5.abrupt(\"return\",roomInfoObj);case 22:case\"end\":return _context5.stop();}}},_callee5);}));return function createRoom(_x7,_x8,_x9,_x10){return _ref6.apply(this,arguments);};}();export var checkRoomExist=/*#__PURE__*/function(){var _ref7=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee6(roomID){var room;return _regeneratorRuntime.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:_context6.next=2;return db.ref(\"\".concat(FIREBASE_COLLECTION.ROOM_INFO,\"/\").concat(roomID,\"/\")).once(\"value\");case 2:room=_context6.sent;return _context6.abrupt(\"return\",room.exists());case 4:case\"end\":return _context6.stop();}}},_callee6);}));return function checkRoomExist(_x11){return _ref7.apply(this,arguments);};}();export var createJob=/*#__PURE__*/function(){var _ref8=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee7(jobInfo){return _regeneratorRuntime.wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:_context7.next=2;return db.ref(\"\".concat(FIREBASE_COLLECTION.JOBS,\"/\").concat(jobInfo.jobId,\"/\")).set(jobInfo);case 2:case\"end\":return _context7.stop();}}},_callee7);}));return function createJob(_x12){return _ref8.apply(this,arguments);};}();export var createInbox=/*#__PURE__*/function(){var _ref9=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee8(userid,roomId,jobId,oppuserid,jobName){var inboxKey;return _regeneratorRuntime.wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:inboxKey=\"\".concat(oppuserid,\"_\").concat(jobId);_context8.next=3;return db.ref(\"\".concat(FIREBASE_COLLECTION.INBOX,\"/\").concat(userid,\"/\").concat(inboxKey)).set({jobId:jobId,jobName:jobName,roomId:roomId,unreadMessages:0});case 3:case\"end\":return _context8.stop();}}},_callee8);}));return function createInbox(_x13,_x14,_x15,_x16,_x17){return _ref9.apply(this,arguments);};}();export var getFirebaseInboxData=/*#__PURE__*/function(){var _ref10=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee10(listner){var userId,dbRef;return _regeneratorRuntime.wrap(function _callee10$(_context11){while(1){switch(_context11.prev=_context11.next){case 0:// debugger;\nuserId=getLoggedInuserId();if(userId){_context11.next=4;break;}listner([]);return _context11.abrupt(\"return\");case 4:dbRef=\"\".concat(FIREBASE_COLLECTION.INBOX,\"/\").concat(userId);console.log(\"getFirebaseIndexData\",dbRef);if(inboxListner){db.ref(dbRef).off();db.ref(dbRef).off(\"value\",msgListnerObj);}inboxListner=db.ref(dbRef).on(\"value\",/*#__PURE__*/function(){var _ref11=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee9(snapshot){var indexlist,items,users,_loop,i;return _regeneratorRuntime.wrap(function _callee9$(_context10){while(1){switch(_context10.prev=_context10.next){case 0:indexlist=[];snapshot.forEach(function(snap){indexlist.push(snap.val());});items=[];users=[];_loop=/*#__PURE__*/_regeneratorRuntime.mark(function _loop(i){var lastMsg,oppUserId,userIndex,oppUserInfo;return _regeneratorRuntime.wrap(function _loop$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:_context9.next=2;return db.ref(\"\".concat(FIREBASE_COLLECTION.LAST_MESSAGES,\"/\").concat(indexlist[i].roomId,\"/chatLastMessage\")).once(\"value\");case 2:lastMsg=_context9.sent;if(lastMsg.exists()){indexlist[i].lastMsg=lastMsg.val();}oppUserId=\"\";if(storageService.getItem(\"userType\")===1){oppUserId=indexlist[i].roomId.split(\"_\")[2];}else{oppUserId=indexlist[i].roomId.split(\"_\")[1];}userIndex=users.findIndex(function(item){return item.userId===oppUserId;});if(!(userIndex==-1)){_context9.next=14;break;}_context9.next=10;return db.ref(\"\".concat(FIREBASE_COLLECTION.USERS,\"/\").concat(oppUserId)).once(\"value\");case 10:oppUserInfo=_context9.sent;if(oppUserInfo.exists()){indexlist[i].oppUserInfo=oppUserInfo.val();users.push(oppUserInfo.val());}_context9.next=15;break;case 14:indexlist[i].oppUserInfo=users[userIndex];case 15:case\"end\":return _context9.stop();}}},_loop);});i=0;case 6:if(!(i<indexlist.length)){_context10.next=11;break;}return _context10.delegateYield(_loop(i),\"t0\",8);case 8:i++;_context10.next=6;break;case 11:setPendingCounter(indexlist);_context10.next=14;return listner(indexlist);case 14:case\"end\":return _context10.stop();}}},_callee9);}));return function(_x19){return _ref11.apply(this,arguments);};}());case 8:case\"end\":return _context11.stop();}}},_callee10);}));return function getFirebaseInboxData(_x18){return _ref10.apply(this,arguments);};}();export var getFirebaseInboxDataForUnreadMsgCount=/*#__PURE__*/function(){var _ref12=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee12(listner){var userId,dbRef;return _regeneratorRuntime.wrap(function _callee12$(_context14){while(1){switch(_context14.prev=_context14.next){case 0:// debugger;\nuserId=getLoggedInuserId();if(userId){_context14.next=4;break;}listner([]);return _context14.abrupt(\"return\");case 4:dbRef=\"\".concat(FIREBASE_COLLECTION.INBOX,\"/\").concat(userId);inboxListner=db.ref(dbRef).on(\"value\",/*#__PURE__*/function(){var _ref13=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee11(snapshot){var indexlist,items,users,_loop2,i;return _regeneratorRuntime.wrap(function _callee11$(_context13){while(1){switch(_context13.prev=_context13.next){case 0:indexlist=[];snapshot.forEach(function(snap){indexlist.push(snap.val());});items=[];users=[];_loop2=/*#__PURE__*/_regeneratorRuntime.mark(function _loop2(i){var lastMsg,oppUserId,userIndex,oppUserInfo;return _regeneratorRuntime.wrap(function _loop2$(_context12){while(1){switch(_context12.prev=_context12.next){case 0:_context12.next=2;return db.ref(\"\".concat(FIREBASE_COLLECTION.LAST_MESSAGES,\"/\").concat(indexlist[i].roomId,\"/chatLastMessage\")).once(\"value\");case 2:lastMsg=_context12.sent;if(lastMsg.exists()){indexlist[i].lastMsg=lastMsg.val();}oppUserId=\"\";if(storageService.getItem(\"userType\")===1){oppUserId=indexlist[i].roomId.split(\"_\")[2];}else{oppUserId=indexlist[i].roomId.split(\"_\")[1];}userIndex=users.findIndex(function(item){return item.userId===oppUserId;});if(!(userIndex==-1)){_context12.next=14;break;}_context12.next=10;return db.ref(\"\".concat(FIREBASE_COLLECTION.USERS,\"/\").concat(oppUserId)).once(\"value\");case 10:oppUserInfo=_context12.sent;if(oppUserInfo.exists()){indexlist[i].oppUserInfo=oppUserInfo.val();users.push(oppUserInfo.val());}_context12.next=15;break;case 14:indexlist[i].oppUserInfo=users[userIndex];case 15:case\"end\":return _context12.stop();}}},_loop2);});i=0;case 6:if(!(i<indexlist.length)){_context13.next=11;break;}return _context13.delegateYield(_loop2(i),\"t0\",8);case 8:i++;_context13.next=6;break;case 11:setPendingCounter(indexlist);_context13.next=14;return listner(indexlist);case 14:case\"end\":return _context13.stop();}}},_callee11);}));return function(_x21){return _ref13.apply(this,arguments);};}());case 6:case\"end\":return _context14.stop();}}},_callee12);}));return function getFirebaseInboxDataForUnreadMsgCount(_x20){return _ref12.apply(this,arguments);};}();export var setPendingCounter=function setPendingCounter(indexlist){var count=0;var unreadMsg=indexlist.filter(function(d){return d.unreadMessages>0;});unreadMsg.length===0?count=0:count=unreadMsg.length;// store.dispatch({\n//     type: INBOX_COUNTER_SET,\n//     payLoad: count\n// });\n};// export const getFirebaseItemsData = async () => {\n//     let itemlist = [];\n//     db.ref(`${FIREBASE_COLLECTION.JOBS}`).on(\"value\", (snapshot) => {\n//         snapshot.forEach((snap) => {\n//             itemlist.push(snap.val());\n//         });\n//     });\n//     return itemlist;\n// }\n// export const getFirebaseRoomInfoData = async () => {\n//     let roomlist = [];\n//     db.ref(`${FIREBASE_COLLECTION.ROOM_INFO}`).on(\"value\", (snapshot) => {\n//         snapshot.forEach((snap) => {\n//             roomlist.push(snap.val());\n//         });\n//     });\n//     return roomlist\n// }\nexport var getMessagesOfRoom=/*#__PURE__*/function(){var _ref14=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee13(roomId,listner){return _regeneratorRuntime.wrap(function _callee13$(_context15){while(1){switch(_context15.prev=_context15.next){case 0://getPreviousMessages check KT file\n//.limitToLast(10)\n// if (msgListnerObj) {\n//     await db.ref(`${FIREBASE_COLLECTION.MESSAGES}/${roomId}`).off('value', msgListnerObj);\n// }\nmsgListnerObj=db.ref(\"\".concat(FIREBASE_COLLECTION.MESSAGES,\"/\").concat(roomId)).orderByChild(\"messageTimestamp\").limitToLast(500).on(\"value\",function(snapshot){var itemlist=[];snapshot.forEach(function(snap){itemlist.push(snap.val());});listner(itemlist);});case 1:case\"end\":return _context15.stop();}}},_callee13);}));return function getMessagesOfRoom(_x22,_x23){return _ref14.apply(this,arguments);};}();export var stopListeningOfRoom=/*#__PURE__*/function(){var _ref15=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee14(roomId){return _regeneratorRuntime.wrap(function _callee14$(_context16){while(1){switch(_context16.prev=_context16.next){case 0:if(msgListnerObj){db.ref(\"\".concat(FIREBASE_COLLECTION.MESSAGES,\"/\").concat(roomId)).off(\"value\",msgListnerObj);db.ref(\"\".concat(FIREBASE_COLLECTION.MESSAGES,\"/\").concat(roomId)).off();}console.log(\"Stop listening Of Room\");case 2:case\"end\":return _context16.stop();}}},_callee14);}));return function stopListeningOfRoom(_x24){return _ref15.apply(this,arguments);};}();export var sendTextMessage=/*#__PURE__*/function(){var _ref16=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee15(roomId,message){var senderId,roomids,jobId,receiverId,dbRef,newMsgRef,messageID,msgData,inboxId;return _regeneratorRuntime.wrap(function _callee15$(_context17){while(1){switch(_context17.prev=_context17.next){case 0:senderId=getLoggedInuserId();roomids=roomId.split(\"_\");jobId=\"\";receiverId=\"\";if(roomids.length==3){if(roomids[1]==senderId){receiverId=roomids[2];}else{receiverId=roomids[1];}jobId=roomids[0];}dbRef=db.ref(\"\".concat(FIREBASE_COLLECTION.MESSAGES,\"/\").concat(roomId));newMsgRef=dbRef.push();// Get the unique key generated by push()\nmessageID=newMsgRef.key;msgData={isBlock:false,isDeleted:false,mediaDuration:\"\",mediaUrl:\"\",messageCaption:\"\",messageId:messageID,messageRoomId:roomId,messageStatus:\"send\",messageText:message,messageTimestamp:firebase.database.ServerValue.TIMESTAMP,messageType:\"text\",progress:0,receiverId:receiverId,senderId:senderId,thumbnail:\"\"};_context17.next=11;return db.ref(\"\".concat(FIREBASE_COLLECTION.LAST_MESSAGES,\"/\").concat(roomId,\"/chatLastMessage\")).set(msgData);case 11:_context17.next=13;return db.ref(\"\".concat(FIREBASE_COLLECTION.MESSAGES,\"/\").concat(roomId,\"/\").concat(messageID)).set(msgData);case 13:msgData.messageTimestamp=moment().toDate().getTime();//TODO Implement Update Message Counter\n//https://stackoverflow.com/questions/42276881/increment-firebase-value-from-javascript-subject-to-constraint\ninboxId=\"\".concat(senderId,\"_\").concat(jobId);_context17.next=17;return db.ref(\"\".concat(FIREBASE_COLLECTION.INBOX,\"/\").concat(receiverId,\"/\").concat(inboxId)).child(\"unreadMessages\").set(firebase.database.ServerValue.increment(1));case 17:return _context17.abrupt(\"return\",msgData);case 18:case\"end\":return _context17.stop();}}},_callee15);}));return function sendTextMessage(_x25,_x26){return _ref16.apply(this,arguments);};}();export var sendImageVideoMessage=/*#__PURE__*/function(){var _ref17=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee16(roomId,url,type){var senderId,roomids,jobId,receiverId,dbRef,newMsgRef,messageID,msgData,inboxId;return _regeneratorRuntime.wrap(function _callee16$(_context18){while(1){switch(_context18.prev=_context18.next){case 0:senderId=getLoggedInuserId();roomids=roomId.split(\"_\");jobId=\"\";receiverId=\"\";if(roomids.length==3){if(roomids[1]==senderId){receiverId=roomids[2];}else{receiverId=roomids[1];}jobId=roomids[0];}dbRef=db.ref(\"\".concat(FIREBASE_COLLECTION.MESSAGES,\"/\").concat(roomId));newMsgRef=dbRef.push();// Get the unique key generated by push()\nmessageID=newMsgRef.key;msgData={isBlock:false,isDeleted:false,mediaDuration:\"\",mediaUrl:url,messageCaption:\"\",messageId:messageID,messageRoomId:roomId,messageStatus:\"send\",messageText:\"\",messageTimestamp:firebase.database.ServerValue.TIMESTAMP,messageType:type===\"image\"?\"image\":\"video\",progress:0,receiverId:receiverId,senderId:senderId,thumbnail:url};_context18.next=11;return db.ref(\"\".concat(FIREBASE_COLLECTION.LAST_MESSAGES,\"/\").concat(roomId,\"/chatLastMessage\")).set(msgData);case 11:_context18.next=13;return db.ref(\"\".concat(FIREBASE_COLLECTION.MESSAGES,\"/\").concat(roomId,\"/\").concat(messageID)).set(msgData);case 13:msgData.messageTimestamp=moment().toDate().getTime();//Implement Update Message Counter\n//https://stackoverflow.com/questions/42276881/increment-firebase-value-from-javascript-subject-to-constraint\ninboxId=\"\".concat(senderId,\"_\").concat(jobId);_context18.next=17;return db.ref(\"\".concat(FIREBASE_COLLECTION.INBOX,\"/\").concat(receiverId,\"/\").concat(inboxId)).child(\"unreadMessages\").set(firebase.database.ServerValue.increment(1));case 17:return _context18.abrupt(\"return\",msgData);case 18:case\"end\":return _context18.stop();}}},_callee16);}));return function sendImageVideoMessage(_x27,_x28,_x29){return _ref17.apply(this,arguments);};}();export var resetUnreadCounter=/*#__PURE__*/function(){var _ref18=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee17(roomId){var senderId,roomids,jobId,receiverId,inboxId;return _regeneratorRuntime.wrap(function _callee17$(_context19){while(1){switch(_context19.prev=_context19.next){case 0:senderId=getLoggedInuserId();roomids=roomId.split(\"_\");jobId=\"\";receiverId=\"\";if(roomids.length===3){if(roomids[1]==senderId){receiverId=roomids[2];}else{receiverId=roomids[1];}jobId=roomids[0];}inboxId=\"\".concat(receiverId,\"_\").concat(jobId);_context19.next=8;return db.ref(\"\".concat(FIREBASE_COLLECTION.INBOX,\"/\").concat(senderId,\"/\").concat(inboxId)).child(\"unreadMessages\").set(0);case 8:case\"end\":return _context19.stop();}}},_callee17);}));return function resetUnreadCounter(_x30){return _ref18.apply(this,arguments);};}();export default firebase;","map":{"version":3,"sources":["/home/appinventiv/Documents/Project/tickt/web/src/services/firebase.js"],"names":["firebase","storageService","Constants","moment","apps","length","initializeApp","qaStgFirebaseConfig","checkIfSupport","messaging","isSupported","auth","db","database","CHAT_TYPE","FIREBASE_COLLECTION","ROOM_INFO","JOBS","INBOX","MESSAGES","LAST_MESSAGES","USERS","loggedInuserId","msgListnerObj","inboxListner","getRegisterToken","Promise","resolve","reject","getToken","vapidKey","FirebasePushServiceKey","then","currentToken","console","log","success","deviceToken","setTokenSentToServer","catch","err","sent","setItem","isTokenSentToServer","getItem","requestPermission","Notification","permission","data","deleteToken","signOut","firebaseSignUpWithEmailPassword","email","password","id","fullName","user_type","createUserWithEmailAndPassword","ref","user","updateProfile","displayName","set","image","name","userId","onlineStatus","userType","firebaseLogInWithEmailPassword","authData","loginRes","isSignup","signInWithEmailAndPassword","response","_id","user_image","userName","loginAnonymously","userInfo","signInAnonymously","update","deviceType","errorCode","code","alert","error","getLoggedInuserId","updateChatUserDetails","updateType","value","isNotification","createRoom","jobId","tradieId","builderId","jobName","roomID","checkRoomExist","roomInfoObj","chatRoomType","chatLastUpdate","ServerValue","TIMESTAMP","chatLastUpdates","chatRoomMembers","memberDelete","memberJoin","memberLeave","createInbox","once","room","exists","createJob","jobInfo","userid","roomId","oppuserid","inboxKey","unreadMessages","getFirebaseInboxData","listner","dbRef","off","on","snapshot","indexlist","forEach","snap","push","val","items","users","i","lastMsg","oppUserId","split","userIndex","findIndex","item","oppUserInfo","setPendingCounter","getFirebaseInboxDataForUnreadMsgCount","count","unreadMsg","filter","d","getMessagesOfRoom","orderByChild","limitToLast","itemlist","stopListeningOfRoom","sendTextMessage","message","senderId","roomids","receiverId","newMsgRef","messageID","key","msgData","isBlock","isDeleted","mediaDuration","mediaUrl","messageCaption","messageId","messageRoomId","messageStatus","messageText","messageTimestamp","messageType","progress","thumbnail","toDate","getTime","inboxId","child","increment","sendImageVideoMessage","url","type","resetUnreadCounter"],"mappings":"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","sourcesContent":["import firebase from \"firebase/app\";\nimport \"firebase/messaging\";\nimport \"firebase/auth\";\nimport \"firebase/database\";\nimport storageService from \"../utils/storageService\";\nimport Constants from \"../utils/constants\";\nimport moment from \"moment\";\n\nif (!firebase.apps.length) {\n  firebase.initializeApp(Constants.qaStgFirebaseConfig);\n}\n\nconst checkIfSupport = () => {\n  if (firebase.messaging.isSupported()) {\n    return firebase.messaging();\n  }\n  return false;\n};\n\nexport const auth = firebase.auth();\nexport const messaging = checkIfSupport(); //firebase.messaging();\nexport const db = firebase.database();\n\nconst CHAT_TYPE = \"single\";\nconst FIREBASE_COLLECTION = {\n  ROOM_INFO: \"room_info\",\n  JOBS: \"jobs\",\n  INBOX: \"inbox\",\n  MESSAGES: \"messages\",\n  LAST_MESSAGES: \"lastMessage\",\n  USERS: \"users\",\n};\nlet loggedInuserId = \"\";\nlet msgListnerObj;\n// let totalPendingCounter = 0;\nlet inboxListner;\n\nconst getRegisterToken = () => {\n  return new Promise((resolve, reject) => {\n    messaging\n      .getToken({\n        vapidKey: Constants.FirebasePushServiceKey,\n      })\n      .then((currentToken) => {\n        if (currentToken) {\n          console.log(\"firebase token fetched successsfully\", currentToken);\n          resolve({ success: true, deviceToken: currentToken });\n        } else {\n          console.log(\"No registration token available.\");\n          setTokenSentToServer(false);\n          resolve({ success: false });\n        }\n      })\n      .catch((err) => {\n        console.log(\"An error occurred while retrieving  from firebase. \", err);\n        setTokenSentToServer(false);\n        reject({ success: false });\n      });\n  });\n};\n\nconst setTokenSentToServer = (sent) => {\n  storageService.setItem(\"sentToServer\", sent ? \"1\" : \"0\");\n  storageService.setItem(\"fcmToken\", \"\");\n};\n\nconst isTokenSentToServer = () => {\n  return storageService.getItem(\"sentToServer\") === \"1\";\n};\n\nexport const requestPermission = () => {\n  if (checkIfSupport()) {\n    return new Promise((resolve, reject) => {\n      Notification.requestPermission()\n        .then((permission) => {\n          const data = getRegisterToken();\n          resolve(data);\n        })\n        // if (permission === 'granted' && isTokenSentToServer()) {\n        //     const data = getRegisterToken();\n        //     console.log('Token Already sent');\n        //     resolve(data);\n        // }\n        .catch((err) => {\n          console.log(\n            \"Unable to get permission to show notification browser : \",\n            err\n          );\n          reject({ success: false });\n        });\n    });\n  }\n};\n\nexport const deleteToken = () => {\n  if (checkIfSupport()) {\n    messaging\n      .deleteToken()\n      .then(() => {\n        console.log(\"firebase Token deleted.\");\n      })\n      .catch((err) => {\n        console.log(\"Unable to delete firebase token. \", err);\n      });\n  }\n};\n\nexport const signOut = () => {\n  auth\n    .signOut()\n    .then(() => {\n      console.log(\"Firebase signout successful.\");\n    })\n    .catch((err) => {\n      console.log(\"Firebase sign out error.\", err);\n    });\n};\n\nexport const firebaseSignUpWithEmailPassword = async ({\n  email,\n  password,\n  id,\n  fullName,\n  user_type,\n}) => {\n  try {\n    let ref = await auth.createUserWithEmailAndPassword(email, password);\n    if (ref) {\n      await ref.user.updateProfile({\n        displayName: fullName,\n        // photoURL: '',\n        // roleId: user_type,\n      });\n\n      await db.ref(`${FIREBASE_COLLECTION.USERS}/${id}`).set({\n        email: email,\n        image: \"\",\n        name: fullName,\n        // uid: ref.user[\"$\"][\"W\"],\n        userId: id,\n        onlineStatus: true,\n        userType: user_type,\n      });\n      console.log(\"firebase authentication success\");\n    }\n  } catch (err) {\n    console.log(\"firebase authentication failure: \", { err });\n  }\n};\n\nexport const firebaseLogInWithEmailPassword = async (\n  authData,\n  loginRes,\n  isSignup\n) => {\n  console.log(\"authData: \", authData);\n  try {\n    let response = await auth.signInWithEmailAndPassword(\n      authData.email,\n      authData.password\n    );\n    if (response) {\n      console.log(\"firebase auth login success: \");\n      if (isSignup) return;\n      await db.ref(`${FIREBASE_COLLECTION.USERS}/${loginRes?._id}`).set({\n        email: loginRes?.email,\n        image: loginRes?.user_image,\n        name: loginRes?.userName,\n        userId: loginRes?._id,\n        onlineStatus: true,\n        userType: loginRes?.user_type,\n      });\n    }\n  } catch (err) {\n    console.log(\"firebase auth login failure: \");\n  }\n};\n\n////////////////////////  firebase chat\n\nexport const loginAnonymously = async () => {\n  let userInfo = storageService.getItem(\"userInfo\");\n  try {\n    let response = await auth.signInAnonymously();\n    if (response) {\n      console.log(\"firebase anonymous auth login success: \");\n      await db.ref(`${FIREBASE_COLLECTION.USERS}/${userInfo?._id}`).update({\n        email: userInfo?.email,\n        image: userInfo?.user_image,\n        name: userInfo?.userName,\n        userId: userInfo?._id,\n        onlineStatus: true,\n        userType: userInfo?.user_type,\n        deviceType: 1,\n      });\n    }\n  } catch (error) {\n    console.log(\"firebase anonymous auth login failure: \");\n    var errorCode = error.code;\n    if (errorCode === \"auth/operation-not-allowed\") {\n      alert(\"You must enable Anonymous auth in the Firebase Console.\");\n    } else {\n      console.error(error);\n    }\n  }\n};\n\nexport const getLoggedInuserId = () => {\n  return storageService.getItem(\"userInfo\")?._id;\n};\n\nexport const updateChatUserDetails = async (updateType, value) => {\n  let loggedInuserId = getLoggedInuserId();\n  try {\n    await db.ref(`${FIREBASE_COLLECTION.USERS}/${loggedInuserId}`).update({\n      ...(updateType === \"userImage\" && { image: value }),\n      ...(updateType === \"userName\" && { name: value }),\n      ...(updateType === \"deviceToken\" && { deviceToken: value }),\n      ...(updateType === \"isNotification\" && { isNotification: value }),\n    });\n    console.log(`firebase ${updateType} update success`);\n  } catch (err) {\n    console.log(`firebase ${updateType} update failure: `, { err });\n  }\n};\n\nexport const createRoom = async (jobId, tradieId, builderId, jobName) => {\n  let loggedInuserId = getLoggedInuserId();\n\n  const roomID = `${jobId}_${tradieId}_${builderId}`;\n\n  if (await checkRoomExist(roomID)) {\n    return;\n  }\n\n  let roomInfoObj = {\n    id: roomID,\n    chatRoomType: CHAT_TYPE,\n    chatLastUpdate: firebase.database.ServerValue.TIMESTAMP,\n  };\n  let chatLastUpdates = {};\n  chatLastUpdates[tradieId] =\n    tradieId === loggedInuserId ? firebase.database.ServerValue.TIMESTAMP : 0;\n  chatLastUpdates[loggedInuserId] = firebase.database.ServerValue.TIMESTAMP;\n\n  let chatRoomMembers = {};\n  chatRoomMembers[tradieId] = {\n    memberDelete: firebase.database.ServerValue.TIMESTAMP,\n    memberJoin: firebase.database.ServerValue.TIMESTAMP,\n    memberLeave: 0,\n  };\n\n  chatRoomMembers[builderId] = {\n    memberDelete: firebase.database.ServerValue.TIMESTAMP,\n    memberJoin: firebase.database.ServerValue.TIMESTAMP,\n    memberLeave: 0,\n  };\n  roomInfoObj.chatRoomMembers = chatRoomMembers;\n  roomInfoObj.chatLastUpdates = chatLastUpdates;\n\n  await db.ref(`${FIREBASE_COLLECTION.ROOM_INFO}/${roomID}/`).set(roomInfoObj);\n  // debugger;\n  // await createItem(itemInfo);\n  //loggedin user inbox\n  await createInbox(tradieId, roomID, jobId, builderId, jobName);\n  // opposite user inbox\n  await createInbox(builderId, roomID, jobId, tradieId, jobName);\n  return roomInfoObj;\n};\n\nexport const checkRoomExist = async (roomID) => {\n  let room = await db\n    .ref(`${FIREBASE_COLLECTION.ROOM_INFO}/${roomID}/`)\n    .once(\"value\");\n  return room.exists();\n};\n\nexport const createJob = async (jobInfo) => {\n  await db.ref(`${FIREBASE_COLLECTION.JOBS}/${jobInfo.jobId}/`).set(jobInfo);\n};\n\nexport const createInbox = async (\n  userid,\n  roomId,\n  jobId,\n  oppuserid,\n  jobName\n) => {\n  const inboxKey = `${oppuserid}_${jobId}`;\n  await db.ref(`${FIREBASE_COLLECTION.INBOX}/${userid}/${inboxKey}`).set({\n    jobId: jobId,\n    jobName: jobName,\n    roomId: roomId,\n    unreadMessages: 0,\n  });\n};\n\nexport const getFirebaseInboxData = async (listner) => {\n  // debugger;\n  let userId = getLoggedInuserId();\n  if (!userId) {\n    listner([]);\n    return;\n  }\n  let dbRef = `${FIREBASE_COLLECTION.INBOX}/${userId}`;\n  console.log(\"getFirebaseIndexData\", dbRef);\n  if (inboxListner) {\n    db.ref(dbRef).off();\n    db.ref(dbRef).off(\"value\", msgListnerObj);\n  }\n  inboxListner = db.ref(dbRef).on(\"value\", async (snapshot) => {\n    let indexlist = [];\n    snapshot.forEach((snap) => {\n      indexlist.push(snap.val());\n    });\n    let items = [];\n    let users = [];\n    for (let i = 0; i < indexlist.length; i++) {\n      // let itemIndex = items.findIndex((item) => item.jobId === indexlist[i].jobId);\n      // if (itemIndex == -1) {\n      //     let room = await db.ref(`${FIREBASE_COLLECTION.JOBS}/${indexlist[i].jobId}`).once('value');\n      //     if (room.exists()) {\n      //         let lastMsg = await db.ref(`${FIREBASE_COLLECTION.LAST_MESSAGES}/${indexlist[i].roomId}/chatLastMessage`).once('value');\n      //         indexlist[i].item = room.val();\n      //         if (lastMsg.exists())\n      //             indexlist[i].lastMsg = lastMsg.val();\n      //         items.push(room.val());\n      //     }\n      // } else {\n      //     indexlist[i].item = items[itemIndex];\n      // }\n      let lastMsg = await db\n        .ref(\n          `${FIREBASE_COLLECTION.LAST_MESSAGES}/${indexlist[i].roomId}/chatLastMessage`\n        )\n        .once(\"value\");\n      if (lastMsg.exists()) {\n        indexlist[i].lastMsg = lastMsg.val();\n      }\n      let oppUserId = \"\";\n      if (storageService.getItem(\"userType\") === 1) {\n        oppUserId = indexlist[i].roomId.split(\"_\")[2];\n      } else {\n        oppUserId = indexlist[i].roomId.split(\"_\")[1];\n      }\n      let userIndex = users.findIndex((item) => item.userId === oppUserId);\n      if (userIndex == -1) {\n        let oppUserInfo = await db\n          .ref(`${FIREBASE_COLLECTION.USERS}/${oppUserId}`)\n          .once(\"value\");\n        if (oppUserInfo.exists()) {\n          indexlist[i].oppUserInfo = oppUserInfo.val();\n          users.push(oppUserInfo.val());\n        }\n      } else {\n        indexlist[i].oppUserInfo = users[userIndex];\n      }\n    }\n    setPendingCounter(indexlist);\n    await listner(indexlist);\n  });\n};\nexport const getFirebaseInboxDataForUnreadMsgCount = async (listner) => {\n  // debugger;\n  let userId = getLoggedInuserId();\n  if (!userId) {\n    listner([]);\n    return;\n  }\n  let dbRef = `${FIREBASE_COLLECTION.INBOX}/${userId}`;\n  inboxListner = db.ref(dbRef).on(\"value\", async (snapshot) => {\n    let indexlist = [];\n    snapshot.forEach((snap) => {\n      indexlist.push(snap.val());\n    });\n    let items = [];\n    let users = [];\n    for (let i = 0; i < indexlist.length; i++) {\n      let lastMsg = await db\n        .ref(\n          `${FIREBASE_COLLECTION.LAST_MESSAGES}/${indexlist[i].roomId}/chatLastMessage`\n        )\n        .once(\"value\");\n      if (lastMsg.exists()) {\n        indexlist[i].lastMsg = lastMsg.val();\n      }\n      let oppUserId = \"\";\n      if (storageService.getItem(\"userType\") === 1) {\n        oppUserId = indexlist[i].roomId.split(\"_\")[2];\n      } else {\n        oppUserId = indexlist[i].roomId.split(\"_\")[1];\n      }\n      let userIndex = users.findIndex((item) => item.userId === oppUserId);\n      if (userIndex == -1) {\n        let oppUserInfo = await db\n          .ref(`${FIREBASE_COLLECTION.USERS}/${oppUserId}`)\n          .once(\"value\");\n        if (oppUserInfo.exists()) {\n          indexlist[i].oppUserInfo = oppUserInfo.val();\n          users.push(oppUserInfo.val());\n        }\n      } else {\n        indexlist[i].oppUserInfo = users[userIndex];\n      }\n    }\n    setPendingCounter(indexlist);\n    await listner(indexlist);\n  });\n};\n\nexport const setPendingCounter = (indexlist) => {\n  let count = 0;\n  let unreadMsg = indexlist.filter((d) => d.unreadMessages > 0);\n  unreadMsg.length === 0 ? (count = 0) : (count = unreadMsg.length);\n  // store.dispatch({\n  //     type: INBOX_COUNTER_SET,\n  //     payLoad: count\n  // });\n};\n\n// export const getFirebaseItemsData = async () => {\n//     let itemlist = [];\n//     db.ref(`${FIREBASE_COLLECTION.JOBS}`).on(\"value\", (snapshot) => {\n//         snapshot.forEach((snap) => {\n//             itemlist.push(snap.val());\n//         });\n//     });\n//     return itemlist;\n// }\n\n// export const getFirebaseRoomInfoData = async () => {\n//     let roomlist = [];\n//     db.ref(`${FIREBASE_COLLECTION.ROOM_INFO}`).on(\"value\", (snapshot) => {\n//         snapshot.forEach((snap) => {\n//             roomlist.push(snap.val());\n//         });\n//     });\n//     return roomlist\n// }\n\nexport const getMessagesOfRoom = async (roomId, listner) => {\n  //getPreviousMessages check KT file\n  //.limitToLast(10)\n\n  // if (msgListnerObj) {\n  //     await db.ref(`${FIREBASE_COLLECTION.MESSAGES}/${roomId}`).off('value', msgListnerObj);\n  // }\n\n  msgListnerObj = db\n    .ref(`${FIREBASE_COLLECTION.MESSAGES}/${roomId}`)\n    .orderByChild(\"messageTimestamp\")\n    .limitToLast(500)\n    .on(\"value\", (snapshot) => {\n      let itemlist = [];\n      snapshot.forEach((snap) => {\n        itemlist.push(snap.val());\n      });\n      listner(itemlist);\n    });\n};\n\nexport const stopListeningOfRoom = async (roomId) => {\n  if (msgListnerObj) {\n    db.ref(`${FIREBASE_COLLECTION.MESSAGES}/${roomId}`).off(\n      \"value\",\n      msgListnerObj\n    );\n    db.ref(`${FIREBASE_COLLECTION.MESSAGES}/${roomId}`).off();\n  }\n  console.log(\"Stop listening Of Room\");\n};\n\nexport const sendTextMessage = async (roomId, message) => {\n  let senderId = getLoggedInuserId();\n  let roomids = roomId.split(\"_\");\n  let jobId = \"\";\n  let receiverId = \"\";\n  if (roomids.length == 3) {\n    if (roomids[1] == senderId) {\n      receiverId = roomids[2];\n    } else {\n      receiverId = roomids[1];\n    }\n    jobId = roomids[0];\n  }\n\n  let dbRef = db.ref(`${FIREBASE_COLLECTION.MESSAGES}/${roomId}`);\n  const newMsgRef = dbRef.push();\n  // Get the unique key generated by push()\n  const messageID = newMsgRef.key;\n\n  let msgData = {\n    isBlock: false,\n    isDeleted: false,\n    mediaDuration: \"\",\n    mediaUrl: \"\",\n    messageCaption: \"\",\n    messageId: messageID,\n    messageRoomId: roomId,\n    messageStatus: \"send\",\n    messageText: message,\n    messageTimestamp: firebase.database.ServerValue.TIMESTAMP,\n    messageType: \"text\",\n    progress: 0,\n    receiverId: receiverId,\n    senderId: senderId,\n    thumbnail: \"\",\n  };\n  await db\n    .ref(`${FIREBASE_COLLECTION.LAST_MESSAGES}/${roomId}/chatLastMessage`)\n    .set(msgData);\n  await db\n    .ref(`${FIREBASE_COLLECTION.MESSAGES}/${roomId}/${messageID}`)\n    .set(msgData);\n  msgData.messageTimestamp = moment().toDate().getTime();\n\n  //TODO Implement Update Message Counter\n  //https://stackoverflow.com/questions/42276881/increment-firebase-value-from-javascript-subject-to-constraint\n  let inboxId = `${senderId}_${jobId}`;\n  await db\n    .ref(`${FIREBASE_COLLECTION.INBOX}/${receiverId}/${inboxId}`)\n    .child(\"unreadMessages\")\n    .set(firebase.database.ServerValue.increment(1));\n  return msgData;\n};\n\nexport const sendImageVideoMessage = async (roomId, url, type) => {\n  let senderId = getLoggedInuserId();\n  let roomids = roomId.split(\"_\");\n  let jobId = \"\";\n  let receiverId = \"\";\n  if (roomids.length == 3) {\n    if (roomids[1] == senderId) {\n      receiverId = roomids[2];\n    } else {\n      receiverId = roomids[1];\n    }\n    jobId = roomids[0];\n  }\n\n  let dbRef = db.ref(`${FIREBASE_COLLECTION.MESSAGES}/${roomId}`);\n  const newMsgRef = dbRef.push();\n  // Get the unique key generated by push()\n  const messageID = newMsgRef.key;\n\n  let msgData = {\n    isBlock: false,\n    isDeleted: false,\n    mediaDuration: \"\",\n    mediaUrl: url,\n    messageCaption: \"\",\n    messageId: messageID,\n    messageRoomId: roomId,\n    messageStatus: \"send\",\n    messageText: \"\",\n    messageTimestamp: firebase.database.ServerValue.TIMESTAMP,\n    messageType: type === \"image\" ? \"image\" : \"video\",\n    progress: 0,\n    receiverId: receiverId,\n    senderId: senderId,\n    thumbnail: url,\n  };\n  await db\n    .ref(`${FIREBASE_COLLECTION.LAST_MESSAGES}/${roomId}/chatLastMessage`)\n    .set(msgData);\n  await db\n    .ref(`${FIREBASE_COLLECTION.MESSAGES}/${roomId}/${messageID}`)\n    .set(msgData);\n  msgData.messageTimestamp = moment().toDate().getTime();\n\n  //Implement Update Message Counter\n  //https://stackoverflow.com/questions/42276881/increment-firebase-value-from-javascript-subject-to-constraint\n  let inboxId = `${senderId}_${jobId}`;\n  await db\n    .ref(`${FIREBASE_COLLECTION.INBOX}/${receiverId}/${inboxId}`)\n    .child(\"unreadMessages\")\n    .set(firebase.database.ServerValue.increment(1));\n  return msgData;\n};\n\nexport const resetUnreadCounter = async (roomId) => {\n  let senderId = getLoggedInuserId();\n  let roomids = roomId.split(\"_\");\n  let jobId = \"\";\n  let receiverId = \"\";\n  if (roomids.length === 3) {\n    if (roomids[1] == senderId) {\n      receiverId = roomids[2];\n    } else {\n      receiverId = roomids[1];\n    }\n    jobId = roomids[0];\n  }\n  let inboxId = `${receiverId}_${jobId}`;\n  await db\n    .ref(`${FIREBASE_COLLECTION.INBOX}/${senderId}/${inboxId}`)\n    .child(\"unreadMessages\")\n    .set(0);\n};\n\nexport default firebase;\n"]},"metadata":{},"sourceType":"module"}